{% extends "base.html" %}

{% block title %}–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ - X5Tech{% endblock %}

{% block content %}
<div class="leaderboard-container">
    <div class="leaderboard-header">
        <div class="header-content">
            <h1>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h1>
            <p>–°–æ—Ä–µ–≤–Ω—É–π—Ç–µ—Å—å —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –∑–∞–π–º–∏—Ç–µ —Ç–æ–ø–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏!</p>

            {% if user %}
            <div class="user-stats">
                <div class="user-stat-card">
                    <div class="stat-value">#{{ user_rank if user_rank else "-" }}</div>
                    <div class="stat-label">–í–∞—à–µ –º–µ—Å—Ç–æ</div>
                </div>
                <div class="user-stat-card">
                    <div class="stat-value">{{ user_points }}</div>
                    <div class="stat-label">–í–∞—à–∏ –±–∞–ª–ª—ã</div>
                </div>
                <div class="user-stat-card">
                    <div class="stat-value">{{ user_games_played }}</div>
                    <div class="stat-label">–°—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="leaderboard-content">
        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
        <div class="leaderboard-filters">
            <div class="filter-group">
                <label for="search-user">–ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
                <input type="text" id="search-user" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ Telegram...">
            </div>
            <div class="filter-group">
                <label>–ü–æ–∫–∞–∑–∞—Ç—å:</label>
                <select id="results-limit">
                    <option value="10">–¢–æ–ø-10</option>
                    <option value="25" selected>–¢–æ–ø-25</option>
                    <option value="50">–¢–æ–ø-50</option>
                    <option value="100">–¢–æ–ø-100</option>
                </select>
            </div>
            <button id="refresh-leaderboard" class="btn btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ -->
        <div class="leaderboard-table-container">
            <div class="table-header">
                <div class="header-rank">–ú–µ—Å—Ç–æ</div>
                <div class="header-user">–£—á–∞—Å—Ç–Ω–∏–∫</div>
                <div class="header-points">–ë–∞–ª–ª—ã</div>
                <div class="header-games">–ò–≥—Ä—ã</div>
                <div class="header-avg">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                <div class="header-badge">–°—Ç–∞—Ç—É—Å</div>
            </div>

            <div class="leaderboard-table">
                {% for player in leaderboard %}
                <div class="leaderboard-row {% if user and player.user_id == user.id %}current-user{% endif %}
                            {% if player.rank == 1 %}first-place{% endif %}
                            {% if player.rank == 2 %}second-place{% endif %}
                            {% if player.rank == 3 %}third-place{% endif %}">
                    <div class="cell-rank">
                        <div class="rank-number">{{ player.rank }}</div>
                        {% if player.rank == 1 %}
                        <div class="rank-crown">üëë</div>
                        {% elif player.rank == 2 %}
                        <div class="rank-medal">ü•à</div>
                        {% elif player.rank == 3 %}
                        <div class="rank-medal">ü•â</div>
                        {% endif %}
                    </div>

                    <div class="cell-user">
                        <div class="user-avatar">
                            <div class="avatar-icon">üë§</div>
                        </div>
                        <div class="user-info">
                            <div class="user-name">{{ player.full_name }}</div>
                            <div class="user-telegram">üîó {{ player.telegram_id }}</div>
                        </div>
                    </div>

                    <div class="cell-points">
                        <span class="points-value">{{ player.total_points }}</span>
                        <div class="points-bar">
                            <div class="points-fill" style="width: {{ (player.total_points / max_points * 100) if max_points > 0 else 0 }}%"></div>
                        </div>
                    </div>

                    <div class="cell-games">
                        {{ player.games_played }}
                    </div>

                    <div class="cell-avg">
                        {% set avg_score = (player.total_points / player.games_played) if player.games_played > 0 else 0 %}
                        <span class="avg-value {{ 'high-score' if avg_score >= 8 else 'medium-score' if avg_score >= 5 else 'low-score' }}">
                            {{ "%.1f"|format(avg_score) }}
                        </span>
                    </div>

                    <div class="cell-badge">
                        {% if player.rank == 1 %}
                        <span class="badge champion">–ß–µ–º–ø–∏–æ–Ω</span>
                        {% elif player.rank <= 3 %}
                        <span class="badge top3">–¢–æ–ø-3</span>
                        {% elif player.rank <= 10 %}
                        <span class="badge top10">–¢–æ–ø-10</span>
                        {% elif player.rank <= 25 %}
                        <span class="badge top25">–¢–æ–ø-25</span>
                        {% else %}
                        <span class="badge participant">–£—á–∞—Å—Ç–Ω–∏–∫</span>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üìä</div>
                    <h3>–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h3>
                    <p>–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!</p>
                    <a href="/games" class="btn btn-primary">–ù–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å</a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã -->
        <div class="platform-stats">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_users }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéÆ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_games_played }}</div>
                    <div class="stat-label">–°—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_points }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-content">
                    <div class="stat-number">{{ "%.1f"|format(avg_points_per_user) }}</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                </div>
            </div>
        </div>

        <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è -->
        <div class="motivation-section">
            <h2>üöÄ –ö–∞–∫ –ø–æ–¥–Ω—è—Ç—å—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ?</h2>
            <div class="tips-grid">
                <div class="tip-card">
                    <div class="tip-icon">üéØ</div>
                    <h3>–£—á–∞—Å—Ç–≤—É–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ</h3>
                    <p>–ö–∞–∂–¥–∞—è —Å—ã–≥—Ä–∞–Ω–Ω–∞—è –∏–≥—Ä–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç –≤–∞–º –±–∞–ª–ª—ã –∏ –æ–ø—ã—Ç</p>
                </div>
                <div class="tip-card">
                    <div class="tip-icon">‚≠ê</div>
                    <h3>–°—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ —Ç–æ—á–Ω–æ—Å—Ç–∏</h3>
                    <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏–Ω–æ—Å—è—Ç –±–æ–ª—å—à–µ –±–∞–ª–ª–æ–≤</p>
                </div>
                <div class="tip-card">
                    <div class="tip-icon">üöÄ</div>
                    <h3>–ò–∑—É—á–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
                    <p>–ó–Ω–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–º–æ–∂–µ—Ç –≤ –∏–≥—Ä–µ "–ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –ª–æ–∂—å"</p>
                </div>
                <div class="tip-card">
                    <div class="tip-icon">üí°</div>
                    <h3>–†–∞–∑–≤–∏–≤–∞–π—Ç–µ –Ω–∞–≤—ã–∫–∏</h3>
                    <p>–ò–≥—Ä–∞ "–ù–∞–π–¥–∏ –±–∞–≥" —É–ª—É—á—à–∏—Ç –≤–∞—à–∏ programming skills</p>
                </div>
            </div>

            <div class="cta-section">
                <h3>–ì–æ—Ç–æ–≤—ã —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥?</h3>
                <p>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–∞–º –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –±–∞–ª–ª—ã!</p>
                <div class="cta-actions">
                    <a href="/games" class="btn btn-primary">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å</a>
                    <a href="/profile" class="btn btn-secondary">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-user');
        const resultsLimit = document.getElementById('results-limit');
        const refreshButton = document.getElementById('refresh-leaderboard');
        const leaderboardRows = document.querySelectorAll('.leaderboard-row');

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();

            leaderboardRows.forEach(row => {
                if (row.classList.contains('empty-state')) return;

                const userName = row.querySelector('.user-name').textContent.toLowerCase();
                const userTelegram = row.querySelector('.user-telegram').textContent.toLowerCase();

                if (userName.includes(searchTerm) || userTelegram.includes(searchTerm)) {
                    row.style.display = 'grid';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        refreshButton.addEventListener('click', function() {
            location.reload();
        });

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
        resultsLimit.addEventListener('change', function() {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
            // –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ø-${this.value} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`);
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #5FAF2D;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 500;
        `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const currentUserRow = document.querySelector('.leaderboard-row.current-user');
        if (currentUserRow) {
            setTimeout(() => {
                currentUserRow.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }, 1000);
        }
    });
</script>
{% endblock %}